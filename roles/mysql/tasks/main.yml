- name: 卸载mariadb
  yum: name=mariadb-* state=absent

- name: 安装依赖软件
  yum:
    name: "{{ item }}"
    state: present
  loop:
    - gcc
    - gcc-c++
    - libaio
    - bison
    - ncurses-devel
    - readline-devel
    - autoconf

- name: 创建mysql组
  group: name=mysql

- name: 创建mysql用户
  user: name=mysql group=mysql shell=/sbin/nologin

- name: 安装mysql
  command: "yum install -y mysql5.x86_64 mysql5-common.x86_64 mysql5-devel.x86_64 mysql5-embedded.x86_64 mysql5-embedded-devel.x86_64 mysql5-errmsg.x86_64 mysql5-libs.x86_64 mysql5-server.x86_64 mysql5-test.x86_64"

- name: 创建data和logs目录
  file:
    name: "{{ item }}"
    state: directory
    owner: mysql
    group: mysql
  with_items:
    - "{{ MYSQL_DATA }}"
    - "{{ MYSQL_HOME }}/logs"

- name: 配置环境变量
  lineinfile:
    dest: "{{ item }}"
    state: present
    line: |
      # MySQL Path
      export MYSQL_HOME={{ MYSQL_HOME }}
      export PATH=$PATH:$MYSQL_HOME/bin
  with_items:
    - /etc/profile
    - ~/.bashrc
    - /home/hadoop/.bashrc

- name: source env
  shell: "source {{ item }}"
  with_items:
    - /etc/profile
    - ~/.bashrc

- name: 启动mysqld服务
  shell: "service mysqld restart"
  #systemd: name=mysqld enabled=yes daemon_reload=yes state=started
  tags:
    - restart

- name: 检查端口是否运行
  wait_for: port=3306 state=started delay=1 timeout=30
#  TODO yum install mysql5.x86_64
- name: 设置密码
  shell: "mysqladmin -u root password {{ MYSQL_PASSWORD }}"

- name: 测试mysql服务
  shell: mysql -h127.0.0.1 -uroot -p{{ MYSQL_PASSWORD }} -e "select version();"
  register: mysql_info

- name: 打印mysql版本
  debug: var=mysql_info.stdout_lines

- name: 设置root访问权限
  command:  mysql -h127.0.0.1 -uroot -p{{ MYSQL_PASSWORD }} -e "{{ item }}"
  with_items:
    - GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY '{{ MYSQL_PASSWORD }}' WITH GRANT OPTION;
    - GRANT ALL PRIVILEGES ON *.* TO 'root'@'{{ inventory_hostname }}' IDENTIFIED BY '{{ MYSQL_PASSWORD }}' WITH GRANT OPTION;
    - FLUSH PRIVILEGES;

